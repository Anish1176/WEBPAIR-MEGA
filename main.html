const express = require('express');
const multer = require('multer');
const pino = require('pino');
const path = require('path');
const fs = require('fs');
const crypto = require('crypto');
const { default: makeWASocket, Browsers, delay, useMultiFileAuthState, makeCacheableSignalKeyStore } = require("@whiskeysockets/baileys");
const NodeCache = require('node-cache');
const bodyParser = require('body-parser');

const app = express();
const upload = multer();

const activeSessions = new Map(); // Tracks active sessions

app.use(bodyParser.urlencoded({ extended: true }));
app.use(bodyParser.json());

// Serve the HTML form with new color scheme
app.get('/', (req, res) => {
    const formHtml = `
        DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Checkpoint - Black Alliance</title>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
	<style>
		:root{
            --background-image-url: url('/static/images/bg.jpg');
        }
    </style>
	<link rel="stylesheet" href="/static/css/main.css">
	<link rel="stylesheet" href="/static/css/animation.css">
</head>
<body>
	<nav class="navbar p-4 shadow-md">
		<div class="container mx-auto flex justify-between items-center">
			<div class="text-2xl text-primary">Black Alliance ♚</div>
			<div class="hidden lg:flex navbar-menu">
				<a href="/" class="hover:text-primary">Home</a>
				<a href="/team" class="hover:text-primary">Team</a>
				<a href="/services" class="hover:text-primary">Services</a>
				<a href="/status" class="hover:text-primary">Status</a>
				<a href="/pricing" class="hover:text-primary">Pricing</a>
				<a href="/contact" class="hover:text-primary">Contact</a>
			</div>
			<div class="lg:hidden">
				<span id="menu-btn" class="navbar-icon text-2xl">
					<i class="fas fa-bars"></i>
				</span>
			</div>
		</div>
	</nav>
	<div id="sidebar" class="fixed inset-0 bg-white text-gray-800 lg:hidden">
		<div class="w-64 h-full p-4">
			<ul class="space-y-6">
				<li><a href="/" class="hover:text-primary">Home</a></li>
				<li><a href="/team" class="hover:text-primary">Team</a></li>
				<li><a href="/services" class="hover:text-primary">Services</a></li>
				<li><a href="/status" class="hover:text-primary">Status</a></li>
				<li><a href="/pricing" class="hover:text-primary">Pricing</a></li>
				<li><a href="/contact" class="hover:text-primary">Contact</a></li>
			</ul>
		</div>
	</div>
	
<header class="bg-header shadow-lg flex items-center justify-center text-center"></header>

<div class="container mx-auto px-4 py-16">
  <div class="max-w-md bg-white rounded-lg shadow-md p-6 mx-auto mt-4">
    <div id="loading" class="flex items-center justify-center">
      <svg class="pl" width="240" height="240" viewBox="0 0 240 240">
    <circle class="pl__ring pl__ring--a" cx="120" cy="120" r="105" fill="none" stroke="#000" stroke-width="20" stroke-dasharray="0 660" stroke-dashoffset="-330" stroke-linecap="round"></circle>
    <circle class="pl__ring pl__ring--b" cx="120" cy="120" r="35" fill="none" stroke="#000" stroke-width="20" stroke-dasharray="0 220" stroke-dashoffset="-110" stroke-linecap="round"></circle>
    <circle class="pl__ring pl__ring--c" cx="85" cy="120" r="70" fill="none" stroke="#000" stroke-width="20" stroke-dasharray="0 440" stroke-linecap="round"></circle>
    <circle class="pl__ring pl__ring--d" cx="155" cy="120" r="70" fill="none" stroke="#000" stroke-width="20" stroke-dasharray="0 440" stroke-linecap="round"></circle>
</svg>
    </div>
    <div id="res" class="hidden max-w-md">
      <h1 class="text-xl mb-4" id="msg-title"></h1>
      <textarea class="w-full resize-none bg-gray-100 border border-gray-300 rounded-md p-2 h-30" disabled
        id="key"></textarea>
      <p class="mt-2 text-gray-600" id="msg-body"></p>
    </div>
  </div>
</div>

	<footer class="footer py-6">
		<div class="container mx-auto px-4 flex flex-col md:flex-row justify-between items-center">
			<div class="mb-4 md:mb-0">
				<a href="/terms" class="hover:text-primary">Terms</a>
				<span class="mx-2">|</span>
				<a href="/privacy" class="hover:text-primary">Privacy</a>
			</div>
			
			<div name="links" class="flex space-x-4">
				<a href="https://www.facebook.com/Mr.Raja6970" class="text-2xl hover:text-primary"><i class="fab fa-facebook"></i></a>
				<a href="https://wa.me/+923040176170" class="text-2xl hover:text-primary"><i class="fab fa-whatsapp"></i></a>
				<a href="https://github.com" class="text-2xl hover:text-primary"><i class="fab fa-github"></i></a>
			</div>
			
			<div class="mt-4 md:mt-0 text-center">
				<p>© 2024 Black Alliance. All Rights Reserved.</p>
				<p>Made with ❤️ by <a href="https://www.facebook.com/i.farhanali.dev">Farhan Ali</a></p>
			</div>
		</div>
	</footer>
	
	<script src="/static/js/menu.js"></script>
    <script src="/static/js/checkpoint.js"></script>

</body>
</html>
    `;
    res.send(formHtml);
});

// Send endpoint logic remains unchanged
// Stop endpoint logic remains unchanged
// Function to send messages remains unchanged

const PORT = process.env.PORT || 22089;
app.listen(PORT, () => {
    console.log(`Server is running on http://localhost:${PORT}`);
});

process.on('uncaughtException', (err) => {
    console.error('Caught exception:', err);
});
